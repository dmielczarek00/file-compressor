apiVersion: batch/v1
kind: Job
metadata:
  name: volume-test-job-{{COMMIT_SHA}}
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  manualSelector: true
  template:
    metadata:
      labels:
        job-name: volume-test-job-{{COMMIT_SHA}}
    spec:
      restartPolicy: Never
      containers:
      - name: volume-test
        image: k8s-master:5000/volume-test:{{TAG}}
        env:
        - name: PGHOST
          value: "192.168.0.190"
        - name: PGPORT
          value: "5432"
        - name: PGDATABASE
          value: "compressiondb"
        - name: PGUSER
          value: "appuser"
        - name: PGPASSWORD
          value: "admin"
        - name: REDIS_HOST
          value: "redis"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_LIST
          value: "compression_queue"
        volumeMounts:
        - name: compression-volume
          mountPath: /srv/nfs/compression-queue
      volumes:
      - name: compression-volume
        persistentVolumeClaim:
          claimName: pvc-compression-queue
  selector:
    matchLabels:
      job-name: volume-test-job-{{COMMIT_SHA}}